<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Test Automation - Day 7</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1, h2, h3 {
            color: #0056b3;
        }
        pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        code {
            font-family: "Courier New", Courier, monospace;
            color: #d44950;
        }
        .slide {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
        }
        .tree {
        background: #fff;
        padding: 16px;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(16,24,40,0.06);
        max-width: 640px;
        font-family: "Courier New", monospace;
        white-space: pre;
        }
    </style>
    <link rel="stylesheet" 
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
</head>
<body>
    <h1>Web Test Automation - Day 7</h1>
    <h3>Running tests in diffent browsers and in parallel</h3>

    <div class="slide">
        <h2>Agenda</h2>
        <ul>
            <li>Updating conftest to run same test case in different browsers</li>
            <li>Generating new report with execution data</li>
            <li>Parallel Execution with `pytest-xdist`</li>
        </ul>
    </div>
    <div class="slide">
        <h2>1. Updating conftest.py </h2>
        <p>Les's update our conftest.py to execute same test case in different browsers</p>
        <h3>On <code>conftest.py</code>:</h3>
        <pre><code class="language-python">import pytest
from selenium import webdriver
import json, time
from pathlib import Path
import os, pytest_html

# def pytest_addoption(parser):
#     parser.addoption("--browser", action="store", default="chrome", help="browser to execute tests (chrome or firefox)")

# @pytest.fixture
@pytest.fixture(params=["chrome", "firefox"], scope="function")
def driver(request):
    # browser = request.config.getoption("--browser").lower()
    browser = request.param
    if browser == "chrome":
        driver_instance = webdriver.Chrome()
    elif browser == "firefox":
        driver_instance = webdriver.Firefox()
    else:
        raise ValueError(f"Browser '{browser}' is not supported.")
    
    driver_instance.maximize_window()
    request.node.browser = browser

    yield driver_instance
    driver_instance.quit()</code></pre>

        <h4>Running a example:</h4>
        <p>Check your test case will run on Firefox and Chromes</p>
        <pre><code>pytest tests/test_tool_tips.py -v </code></pre>
        <h4>Output:</h4>
        <pre><code class="language-python">rootdir: /Users/rodrigoprado/rgp/ProgramaEstagio/estagio-automacao
configfile: pytest.ini
plugins: allure-pytest-2.15.0, html-4.1.1, xdist-3.8.0, metadata-3.1.1, cov-6.3.0
collected 4 items                                                                                                                                                               

tests/test_tool_tips_original.py::test_button_tooltip[chrome] PASSED                                                                                                      [ 25%]
tests/test_tool_tips_original.py::test_button_tooltip[firefox] PASSED                                                                                                     [ 50%]
tests/test_tool_tips_original.py::test_field_tooltip[chrome] PASSED                                                                                                       [ 75%]
tests/test_tool_tips_original.py::test_field_tooltip[firefox] PASSED   </code></pre>
    </div>
     <div class="slide">
        <h2>2. Generating new report with execution data`</h2>
        <p>Let's update our <strong><code>conftest.py</code></strong> again to create a new report with the execution data</p>
        
        <pre><code class="language-python">import csv

report_data = []

@pytest.hookimpl(hookwrapper=True)
def pytest_runtest_makereport(item, call):

    outcome = yield
    report = outcome.get_result()
    extra = getattr(report, "extra", [])
    if report.when == "call": # and report.failed:

        status = 'Passed' if report.passed else 'Failed'
        browser = getattr(item, 'browser', 'N/A')
        test_name = item.name
        duration = f"{report.duration:.4f}s"

        if report.failed:
            # Create screenshots directory if it doesn't exist
            if not os.path.exists("screenshots"):
                os.makedirs("screenshots")
            # Take screenshot
            driver = item.funcargs['driver']
            screenshot_file = os.path.join("screenshots", f"{item.name}_error.png")
            driver.save_screenshot(screenshot_file)
            # Add screenshot to the HTML report
            if screenshot_file:
                html = f'&lt;div&gt;&lt;img src="{screenshot_file}" alt="screenshot" style="width:304px;height:228px;" ' \
            f'onclick="window.open(this.src)" align="right"/&gt;&lt;/div&gt;'
                    extra.append(pytest_html.extras.html(html))
        
        report_data.append({
            "browser": browser.capitalize(),
            "test_case_name": test_name,
            "status": status,
            "timestamp": duration
        })

    report.extra = extra

def pytest_sessionfinish(session):
    """
    Hook executed in the end of test session to create the CSV report.
    """
    if not report_data:
        return
        
    # Ordena os dados por navegador para um relatório mais legível
    sorted_reports = sorted(report_data, key=lambda x: x['navegador'])
    
    keys = sorted_reports[0].keys()
    
    with open('test_report.csv', 'w', newline='') as output_file:
        dict_writer = csv.DictWriter(output_file, fieldnames=keys)
        dict_writer.writeheader()
        dict_writer.writerows(sorted_reports)

    print("\nReport 'test_report.csv' generated successfully")</code></pre>
        <h3>Run any test again, for instance:</h3>
        <pre><code class="language-python">pytest tests/test_tool_tips_original.py -v</code></pre>
        <h4>Output:</h4>
        <pre><code class="language-python">rootdir: /Users/rodrigoprado/rgp/ProgramaEstagio/estagio-automacao
configfile: pytest.ini
plugins: allure-pytest-2.15.0, html-4.1.1, xdist-3.8.0, metadata-3.1.1, cov-6.3.0
collected 4 items                                                                                                                                                               

tests/test_tool_tips_original.py::test_button_tooltip[chrome] PASSED                                                                                                      [ 25%]
tests/test_tool_tips_original.py::test_button_tooltip[firefox] PASSED                                                                                                     [ 50%]
tests/test_tool_tips_original.py::test_field_tooltip[chrome] PASSED                                                                                                       [ 75%]
tests/test_tool_tips_original.py::test_field_tooltip[firefox] PASSED   </code></pre>
<h4>Check 'test_report.csv file created in the project root</h4>
<p><img src="screenshots/test_report.png" alt="HTML report created" style="max-width:auto; height:150px;"></p>
<pre><code># test_report.csv
browser,test_case_name,status,timestamp
Chrome,test_button_tooltip[chrome],Passed,5.1125s
Chrome,test_field_tooltip[chrome],Failed,14.3820s
Firefox,test_button_tooltip[firefox],Passed,8.5066s
Firefox,test_field_tooltip[firefox],Passed,8.2310s</code></pre>
    </div>
    <div class="slide">
        <h2>3. Parallel Execution with `pytest-xdist`</h2>
        <p><strong>pytest-xdist</strong> is a Pytest plugin that allows you to:</p>
        <ul>
        <li><strong>Run tests in parallel</strong> (multiple test processes at the same time).</li>
        <li><strong>Distribute tests</strong> across multiple CPUs or even different machines.</li>
        <li><strong>Speed up test suite execution</strong>, especially when there are many long-running tests.</li>
        </ul>
        <h3>Installation:</h3>
        <pre><code class="language-python">pip install pytest-xdist</code></pre>
        <h3>Usage:</h3>
        <pre><code class="language-python"># Run tests in 2 parallel processes locally
pytest -n 2</code></pre>
        <h3>Structure project example: (<code>teste-tools</code>)</h3>
          <div class="tree">tests/
├── test_demoqa.py
├── test_buttons.py
├── test_math.py
└── test_strings.py</div>
    <h3>Running in parallel</code>:</h3>
    <pre><code>% pytest -n 2
===================================================== test session starts =====================================================
platform darwin -- Python 3.9.6, pytest-8.4.2, pluggy-1.6.0
rootdir: /Users/rodrigoprado/rgp/ProgramaEstagio/teste-tools
plugins: xdist-3.8.0
2 workers [9 items]     
.........</code></pre>
    </div>

    <div class="slide">
        <h3>Happy automation testing!</h3>
    </div>

</body>
</html>